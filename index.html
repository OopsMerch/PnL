<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>PnL</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(() => console.log('SW registered'))
                .catch(err => console.log('SW error', err));
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --z-back: 0; --z-content: 10; --z-dock: 100; --z-sheet: 200; --z-modal: 300;
            --bg: #000000; --card: #141414; --border: #262626; --text-main: #ffffff; --text-sec: #808080;
            --accent: #ffffff; --accent-text: #000000; --income: #32d74b; --expense: #ff453a;
            --dock-h: 80px; --safe-top: env(safe-area-inset-top, 20px); --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        [data-theme="midnight"] { --bg: #0b0c15; --card: #151621; --border: #2d2e3d; }
        [data-theme="forest"] { --bg: #051105; --card: #0f1f0f; --border: #1e331e; }
        [data-theme="cherry"] { --bg: #1a0505; --card: #2b0f0f; --border: #4a1a1a; }
        [data-theme="slate"]  { --bg: #0f172a; --card: #1e293b; --border: #334155; }
        [data-theme="light"] { 
            --bg: #f2f2f7; --card: #ffffff; --border: #e5e5ea; 
            --text-main: #000000; --text-sec: #8e8e93; --accent-text: #fff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; font-family: 'Inter', sans-serif; }
        body { 
            background-color: var(--bg); color: var(--text-main); 
            margin: 0; height: 100dvh; 
            overflow: hidden; 
            display: flex; flex-direction: column;
            transition: background 0.3s;
        }
        
        input { user-select: text; -webkit-appearance: none; appearance: none; border-radius: 0; outline: none; }
        .hidden { display: none !important; }
        .mono { font-family: 'JetBrains Mono', monospace; }

        .scroll-area {
            flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
            padding: calc(var(--safe-top) + 20px) 16px calc(var(--dock-h) + var(--safe-bottom) + 30px) 16px;
            scrollbar-width: none;
            position: relative;
            z-index: var(--z-content);
        }
        .scroll-area::-webkit-scrollbar { display: none; }

        .balance-block { padding: 10px 4px 30px 4px; }
        .balance-label { font-size: 14px; font-weight: 800; color: var(--text-sec); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px; }
        .balance-val { 
            font-size: 42px; font-weight: 800; letter-spacing: -1px; line-height: 1; 
            color: var(--accent); transition: color 0.3s;
        }

        .chart-box {
            height: 260px; width: 100%;
            background: var(--card); border: 1px solid var(--border); border-radius: 28px;
            padding: 20px; margin-bottom: 24px; position: relative;
            display: flex; flex-direction: column;
        }
        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            margin-bottom: 15px; z-index: 10;
        }
        .stat-item { display: flex; flex-direction: column; }
        .stat-label { font-size: 11px; color: var(--text-sec); font-weight: 600; margin-bottom: 4px; }
        .stat-val { font-size: 16px; font-weight: 700; }
        .stat-val.inc { color: var(--income); }
        .stat-val.exp { color: var(--expense); }

        .chart-wrapper { flex: 1; position: relative; width: 100%; min-height: 0; }

        .date-sticky {
            position: sticky; top: -1px;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            padding: 12px 4px 8px; font-size: 13px; font-weight: 700; color: var(--text-sec);
            z-index: 10; margin-top: 10px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between;
        }
        [data-theme="light"] .date-sticky { background: rgba(255,255,255,0.85); }

        .tx-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 4px; border-bottom: 1px solid var(--border);
        }
        
        .tx-left { display: flex; align-items: center; gap: 14px; overflow: hidden; min-width: 0; flex: 1; }
        .tx-icon {
            width: 48px; height: 48px; flex-shrink: 0;
            background: var(--card); border: 1px solid var(--border); border-radius: 18px;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-main);
        }
        .tx-meta { display: flex; flex-direction: column; gap: 3px; overflow: hidden; min-width: 0; flex: 1; }
        .tx-cat { font-size: 15px; font-weight: 600; white-space: nowrap; }
        .tx-note { font-size: 13px; color: var(--text-sec); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tx-amount { font-size: 16px; font-weight: 700; white-space: nowrap; margin-left: 10px; }
        .inc { color: var(--income); }
        .exp { color: var(--expense); }

        .dock {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: calc(var(--dock-h) + var(--safe-bottom));
            background: var(--bg); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: flex-start;
            padding-top: 12px; z-index: var(--z-dock);
        }
        @supports (backdrop-filter: blur(20px)) {
            .dock { background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
            [data-theme="light"] .dock { background: rgba(255,255,255,0.8); }
        }

        .dock-btn {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            color: var(--text-sec); font-size: 11px; font-weight: 600; width: 64px;
            background: transparent; border: none; padding: 0;
        }
        .dock-btn.active { color: var(--accent); }
        
        .dock-add {
            width: 60px; height: 60px;
            background: var(--accent); color: var(--accent-text);
            border-radius: 22px; display: flex; align-items: center; justify-content: center;
            margin-top: -30px; border: 5px solid var(--bg);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .sheet {
            position: fixed; inset: 0; background: var(--bg); z-index: var(--z-sheet);
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column; padding-top: var(--safe-top);
        }
        .sheet.open { transform: translateY(0); }
        
        .sheet-head { height: 60px; padding: 0 16px; display: flex; align-items: center; justify-content: space-between; }

        .calc-body { flex: 1; display: flex; flex-direction: column; justify-content: flex-end; padding-bottom: 12px; }
        .calc-display { font-size: 52px; font-weight: 700; text-align: right; padding: 0 20px; margin-bottom: 20px; letter-spacing: -2px; }
        
        .input-bar { display: flex; gap: 12px; padding: 0 16px 20px; max-width: 100%; }
        
        .t-input {
            background: var(--card); border: 1px solid var(--border); border-radius: 14px;
            color: var(--text-main); font-size: 16px; padding: 14px;
            display: flex; align-items: center; justify-content: center;
            position: relative;
            line-height: 1;
        }
        
        .date-overlay { position: absolute; inset: 0; opacity: 0; z-index: 10; width: 100%; height: 100%; }

        .cat-scroll { 
            display: flex; gap: 16px; overflow-x: auto; 
            padding: 12px 16px 20px;
            -webkit-overflow-scrolling: touch; scrollbar-width: none;
        }
        .cat-scroll::-webkit-scrollbar { display: none; }
        
        .cat-chip { 
            opacity: 0.5; display: flex; flex-direction: column; align-items: center; gap: 8px; 
            width: 60px; flex-shrink: 0; transition: 0.2s; position: relative;
        }
        .cat-chip.selected { opacity: 1; transform: scale(1.05); }
        
        .cat-box { 
            width: 56px; height: 56px; background: var(--card); border: 1px solid var(--border); border-radius: 20px;
            display: flex; align-items: center; justify-content: center; position: relative;
            flex-shrink: 0; color: var(--text-main);
        }
        .cat-chip.selected .cat-box { background: var(--accent); color: var(--accent-text); border-color: var(--accent); }
        
        .del-badge {
            position: absolute; top: -8px; right: -8px; width: 22px; height: 22px;
            background: var(--expense); border-radius: 50%; color: #fff;
            display: flex; align-items: center; justify-content: center;
            transform: scale(0); transition: 0.2s; border: 2px solid var(--bg);
            z-index: 20;
        }
        .cat-chip.editing .del-badge { transform: scale(1); }

        .numpad { 
            display: grid; grid-template-columns: repeat(4, 1fr); 
            background: var(--card); padding-bottom: calc(var(--safe-bottom) + 8px); 
            border-top: 1px solid var(--border);
        }
        .key { height: 68px; display: flex; align-items: center; justify-content: center; font-size: 26px; font-weight: 500; cursor: pointer; }
        .key:active { background: rgba(255,255,255,0.05); }
        
        .type-tog { display: flex; background: var(--card); padding: 4px; border-radius: 12px; border: 1px solid var(--border); }
        .type-btn { padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; color: var(--text-sec); }
        .type-btn.active { background: var(--accent); color: var(--accent-text); }
        .type-btn.active.exp { background: var(--expense); color: #fff; }
        .type-btn.active.inc { background: var(--income); color: #fff; }

        .set-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 18px 0; border-bottom: 1px solid var(--border); font-size: 16px;
        }
        
        .color-grid { 
            display: flex; gap: 14px; margin-top: 15px; overflow-x: auto; 
            padding: 4px 4px 12px 4px;
            scrollbar-width: none;
        }
        .color-dot { 
            width: 44px; height: 44px; border-radius: 50%; border: 2px solid var(--border); 
            flex-shrink: 0;
            transition: transform 0.2s;
        }
        .color-dot.active { border-color: var(--text-main); transform: scale(1.1); }

        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: var(--z-modal);
            display: flex; align-items: flex-end; opacity: 0; pointer-events: none; transition: 0.2s;
            backdrop-filter: blur(5px);
        }
        .modal.open { opacity: 1; pointer-events: all; }
        .modal-card {
            width: 100%; background: var(--bg); border-top: 1px solid var(--border);
            border-radius: 24px 24px 0 0; padding: 24px; padding-bottom: calc(var(--safe-bottom) + 24px);
            transform: translateY(100%); transition: 0.3s;
        }
        .modal.open .modal-card { transform: translateY(0); }
    </style>
</head>
<body>

    <div class="scroll-area">
        <div class="balance-block">
            <div class="balance-label">PnL</div>
            <div class="balance-val mono" id="total-bal">0.00</div>
        </div>
        <div class="chart-box">
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">Вчера</span>
                    <span class="stat-val mono" id="stat-prev">0.00</span>
                </div>
                <div class="stat-item" style="align-items:flex-end">
                    <span class="stat-label">Сегодня</span>
                    <span class="stat-val mono" id="stat-today">0.00</span>
                </div>
            </div>
            <div class="chart-wrapper"><canvas id="mainChart"></canvas></div>
        </div>
        <div id="tx-list"></div>
    </div>

    <div class="dock">
        <button class="dock-btn active" onclick="App.scrollTop()"><i data-lucide="layout-grid" width="24"></i><span>Главная</span></button>
        <div class="dock-add" onclick="App.openCalc()"><i data-lucide="plus" width="32"></i></div>
        <button class="dock-btn" onclick="App.openSettings()"><i data-lucide="settings-2" width="24"></i><span>Меню</span></button>
    </div>

    <div class="sheet" id="calc-sheet">
        <div class="sheet-head">
            <div onclick="App.closeCalc()"><i data-lucide="x" style="color:var(--text-sec)"></i></div>
            <div class="type-tog">
                <div class="type-btn active exp" id="btn-exp" onclick="Calc.setType('expense')">Расход</div>
                <div class="type-btn" id="btn-inc" onclick="Calc.setType('income')">Доход</div>
            </div>
            <div style="width:24px" id="del-btn-con"></div>
        </div>
        <div class="calc-body">
            <div class="calc-display mono" id="calc-disp">0</div>
            <div class="input-bar">
                <div class="t-input" style="flex:0.4; min-width: 110px;"><i data-lucide="calendar" width="16" style="margin-right:8px"></i><span id="date-disp">Сегодня</span><input type="date" class="date-overlay" onchange="Calc.setDate(this.value)"></div>
                <input type="text" class="t-input" id="note-input" style="flex:1" placeholder="Комментарий" autocomplete="off">
            </div>
            <div class="cat-scroll" id="cat-list"></div>
        </div>
        <div class="numpad">
            <div class="key" onclick="Calc.clear()" style="color:var(--text-sec)">C</div>
            <div class="key" onclick="Calc.toggle()" style="color:var(--text-sec)">±</div>
            <div class="key" onclick="Calc.percent()" style="color:var(--text-sec)">%</div>
            <div class="key" onclick="Calc.press('/')" style="color:var(--accent)">÷</div>

            <div class="key" onclick="Calc.press('7')">7</div>
            <div class="key" onclick="Calc.press('8')">8</div>
            <div class="key" onclick="Calc.press('9')">9</div>
            <div class="key" onclick="Calc.press('*')" style="color:var(--accent)">×</div>

            <div class="key" onclick="Calc.press('4')">4</div>
            <div class="key" onclick="Calc.press('5')">5</div>
            <div class="key" onclick="Calc.press('6')">6</div>
            <div class="key" onclick="Calc.press('-')" style="color:var(--accent)">-</div>

            <div class="key" onclick="Calc.press('1')">1</div>
            <div class="key" onclick="Calc.press('2')">2</div>
            <div class="key" onclick="Calc.press('3')">3</div>
            <div class="key" onclick="Calc.press('+')" style="color:var(--accent)">+</div>

            <div class="key" style="grid-column: span 2" onclick="Calc.press('0')">0</div>
            <div class="key" onclick="Calc.press('.')">.</div>
            <div class="key" onclick="Calc.save()" style="background:var(--accent); color:var(--accent-text); border-radius:18px; margin:6px">
                <i data-lucide="check" width="28"></i>
            </div>
        </div>
    </div>

    <div class="sheet" id="set-sheet" style="padding:20px; padding-top:var(--safe-top)">
        <div class="sheet-head" style="padding:0; margin-bottom:20px"><h2>Меню</h2><div onclick="App.closeSettings()"><i data-lucide="x"></i></div></div>
        <div style="overflow-y:auto; padding-bottom:50px">
            <div class="set-row" onclick="App.share()"><span>Поделиться балансом</span><i data-lucide="share-2" width="16"></i></div>
            <div class="set-row" onclick="Modals.openCur()"><span>Валюта</span><span id="set-cur" class="mono" style="color:var(--text-sec)">RUB</span></div>
            <div class="set-row" style="display:block"><span style="display:block; margin-bottom:15px">Тема</span><div class="color-grid" id="theme-grid"></div></div>
            <div class="set-row" style="display:block"><span style="display:block; margin-bottom:15px">Акцент</span><div class="color-grid" id="accent-grid"></div></div>
            <div class="set-row" onclick="App.exportData()"><span>Скачать JSON</span><i data-lucide="download" width="16"></i></div>
            <div class="set-row" onclick="document.getElementById('file-imp').click()"><span>Загрузить JSON</span><i data-lucide="upload" width="16"></i></div>
            <input type="file" id="file-imp" class="hidden" onchange="App.importData(this)">
            <div class="set-row text-expense" onclick="App.nuke()" style="border:none; margin-top:20px; color:var(--expense)"><span>Сброс данных</span><i data-lucide="trash-2" width="16"></i></div>
        </div>
    </div>

    <div class="modal" id="modal-gen"><div class="modal-card"><h3 id="modal-title" style="margin-top:0">Выбор</h3><div id="modal-body"></div><button class="t-input" style="width:100%; margin-top:20px; font-weight:700" onclick="Modals.close()">Закрыть</button></div></div>

    <script>
        const DB_KEY = 'pnl_v1_store';
        const ICONS = ['shopping-bag', 'coffee', 'car', 'home', 'gamepad-2', 'shirt', 'wifi', 'zap', 'heart', 'plane', 'book', 'gift', 'music', 'briefcase', 'monitor', 'smile', 'key', 'wrench', 'sun', 'star', 'tag', 'flag'];
        const CURRENCIES = ['RUB', 'USD', 'EUR', 'KZT', 'UAH', 'BYN', 'TRY', 'CNY'];
        const THEMES = [{id:'oled', hex:'#000'}, {id:'midnight', hex:'#0b0c15'}, {id:'forest', hex:'#051105'}, {id:'cherry', hex:'#1a0505'}, {id:'slate', hex:'#0f172a'}, {id:'light', hex:'#f2f2f7'}];
        const ACCENTS = ['#ffffff', '#0a84ff', '#ff9f0a', '#30d158', '#bf5af2', '#ff375f'];

        const DefState = { txs: [], cats: { expense: [ {id:'e1', name:'Еда', icon:'coffee'}, {id:'e2', name:'Авто', icon:'car'} ], income: [ {id:'i1', name:'ЗП', icon:'briefcase'} ] }, settings: { currency: 'RUB', theme: 'oled', accent: '#ffffff' }, rates: { 'RUB': 1 } };
        const Store = { get() { try { const d = JSON.parse(localStorage.getItem(DB_KEY) || 'null'); return d ? d : JSON.parse(JSON.stringify(DefState)); } catch { return JSON.parse(JSON.stringify(DefState)); } }, set(d) { localStorage.setItem(DB_KEY, JSON.stringify(d)); } };
        const MathX = { 
            safeEval(s) { 
                try { 
                    const cleaned = s.replace(/[^0-9+\-*/.]/g, '');
                    return new Function('return ' + (cleaned || '0'))() || 0; 
                } catch { return 0; } 
            }, 
            fmt(n) { return n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); } 
        };

        const App = {
            data: null, chart: null, catEdit: false,
            async init() {
                this.data = Store.get();
                if(navigator.onLine) { try { const r = await fetch('https://api.exchangerate-api.com/v4/latest/RUB'); const j = await r.json(); if(j.rates) { this.data.rates = j.rates; Store.set(this.data); } } catch(e){} }
                this.applyStyle(); this.render();
            },
            applyStyle() {
                const s = this.data.settings;
                document.documentElement.setAttribute('data-theme', s.theme);
                document.documentElement.style.setProperty('--accent', s.accent);
                const accText = (s.accent === '#ffffff' || s.accent === '#30d158' || s.accent === '#ff9f0a') ? '#000000' : '#ffffff';
                document.documentElement.style.setProperty('--accent-text', accText);
            },
            conv(v) { return v * (this.data.rates[this.data.settings.currency] || 1); },
            toBase(v) { return v / (this.data.rates[this.data.settings.currency] || 1); },
            render() { this.renderBal(); this.renderList(); this.renderChart(); this.renderSettings(); document.getElementById('set-cur').innerText = this.data.settings.currency; lucide.createIcons(); },
            renderBal() { const rub = this.data.txs.reduce((a,t) => t.type==='income' ? a+t.amount : a-t.amount, 0); document.getElementById('total-bal').innerText = `${MathX.fmt(this.conv(rub))} ${this.data.settings.currency}`; },
            renderList() {
                const el = document.getElementById('tx-list'); el.innerHTML = ''; const grp = {};
                [...this.data.txs].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(t => { if(!grp[t.date]) grp[t.date] = []; grp[t.date].push(t); });
                Object.entries(grp).forEach(([d, txs]) => {
                    const sum = txs.reduce((a,t) => t.type==='income' ? a+t.amount : a-t.amount, 0);
                    const head = document.createElement('div'); head.className = 'date-sticky'; head.innerHTML = `<span>${new Date(d).toLocaleDateString()}</span><span>${sum>0?'+':''}${MathX.fmt(this.conv(sum))}</span>`;
                    el.appendChild(head);
                    txs.forEach(t => {
                        const row = document.createElement('div'); row.className = 'tx-item'; row.onclick = () => { Calc.load(t); App.openCalc(); };
                        row.innerHTML = `<div class="tx-left"><div class="tx-icon"><i data-lucide="${t.icon}"></i></div><div class="tx-meta"><span class="tx-cat">${t.catName}</span>${t.note ? `<span class="tx-note">${t.note}</span>` : ''}</div></div><div class="tx-amount ${t.type==='income'?'inc':'exp'}">${t.type==='income'?'+':'-'}${MathX.fmt(this.conv(t.amount))}</div>`;
                        el.appendChild(row);
                    });
                });
            },
            renderChart() {
                const ctx = document.getElementById('mainChart').getContext('2d'); if(this.chart) this.chart.destroy();
                const labels = [], data = [], now = new Date(); let statPrev = 0, statToday = 0;
                const todayIso = new Date().toLocaleDateString('en-CA'), prevIso = new Date(Date.now() - 86400000).toLocaleDateString('en-CA');
                for(let i=6; i>=0; i--) { const d = new Date(now); d.setDate(d.getDate()-i); const iso = d.toLocaleDateString('en-CA'); labels.push(d.toLocaleDateString('ru-RU', {weekday:'short'})); const daySum = this.data.txs.filter(t=>t.date===iso).reduce((a,t)=>t.type==='income'?a+t.amount:a-t.amount,0); data.push(this.conv(daySum)); if(iso === todayIso) statToday = daySum; if(iso === prevIso) statPrev = daySum; }
                const fmt = (n) => `${n>0?'+':''}${MathX.fmt(this.conv(n))} ${this.data.settings.currency}`;
                const elPrev = document.getElementById('stat-prev'), elToday = document.getElementById('stat-today');
                elPrev.innerText = fmt(statPrev); elPrev.className = `stat-val mono ${statPrev>=0?'inc':'exp'}`;
                elToday.innerText = fmt(statToday); elToday.className = `stat-val mono ${statToday>=0?'inc':'exp'}`;
                this.chart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ data, backgroundColor: this.data.settings.accent, borderRadius: 4, barThickness: 12 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend:false }, scales: { x:{grid:{display:false}}, y:{display:false} } } });
            },
            renderSettings() {
                const tg = document.getElementById('theme-grid'); tg.innerHTML = ''; THEMES.forEach(t => { const d = document.createElement('div'); d.className = `color-dot ${this.data.settings.theme===t.id?'active':''}`; d.style.background = t.hex; d.onclick = () => { this.data.settings.theme = t.id; Store.set(this.data); this.applyStyle(); this.renderSettings(); }; tg.appendChild(d); });
                const ag = document.getElementById('accent-grid'); ag.innerHTML = ''; ACCENTS.forEach(c => { const d = document.createElement('div'); d.className = `color-dot ${this.data.settings.accent===c?'active':''}`; d.style.background = c; d.onclick = () => { this.data.settings.accent = c; Store.set(this.data); this.applyStyle(); this.render(); }; ag.appendChild(d); });
            },
            share() {
                const bal = document.getElementById('total-bal').innerText;
                const link = window.location.href;
                const text = `Мой финансовый отчет в PnL:\nТекущий баланс ${bal}.\n\nСсылка на PnL:\n${link}`;
                if (navigator.share) {
                    navigator.share({ title: 'PnL Finance', text: text }).catch((err) => console.log('Share error', err));
                } else { 
                    navigator.clipboard.writeText(text); alert('Данные скопированы в буфер обмена'); 
                }
            },
            openCalc() { document.getElementById('calc-sheet').classList.add('open'); if(!Calc.editId) Calc.reset(); },
            closeCalc() { document.getElementById('calc-sheet').classList.remove('open'); Calc.reset(); },
            openSettings() { document.getElementById('set-sheet').classList.add('open'); },
            closeSettings() { document.getElementById('set-sheet').classList.remove('open'); },
            scrollTop() { document.querySelector('.scroll-area').scrollTo({top:0, behavior:'smooth'}); },
            nuke() { if(confirm('Сбросить всё?')) { localStorage.removeItem(DB_KEY); location.reload(); } },
            exportData() { const b = new Blob([JSON.stringify(this.data)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `pnl_backup.json`; a.click(); },
            importData(el) { const f = el.files[0]; if(f) { const r = new FileReader(); r.onload = (e) => { try { Store.set(JSON.parse(e.target.result)); location.reload(); } catch { alert('Ошибка файла'); } }; r.readAsText(f); } }
        };

        const Calc = {
            buf: '0', type: 'expense', cat: null, editId: null, date: null,
            reset() { this.buf = '0'; this.editId = null; App.catEdit = false; this.setType('expense'); this.setDate(new Date().toLocaleDateString('en-CA')); document.getElementById('note-input').value = ''; document.getElementById('del-btn-con').innerHTML = ''; this.upd(); },
            setDate(isoDate) { this.date = isoDate; document.getElementById('date-disp').innerText = new Date(isoDate).toLocaleDateString(); document.querySelector('.date-overlay').value = isoDate; },
            load(t) {
                this.editId = t.id; this.setType(t.type); this.buf = App.conv(t.amount).toString(); this.cat = App.data.cats[t.type].find(c=>c.id===t.catId); this.setDate(t.date); document.getElementById('note-input').value = t.note || '';
                const del = document.getElementById('del-btn-con'); del.innerHTML = `<i data-lucide="trash-2" style="color:var(--expense)" onclick="Calc.trash()"></i>`; lucide.createIcons({root:del}); this.upd(); this.renderCats();
            },
            trash() { if(confirm('Удалить?')) { App.data.txs = App.data.txs.filter(t => t.id !== this.editId); Store.set(App.data); App.render(); App.closeCalc(); } },
            setType(t) { this.type = t; document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active', 'exp', 'inc')); const btn = document.getElementById(t==='expense'?'btn-exp':'btn-inc'); btn.classList.add('active', t==='expense'?'exp':'inc'); this.cat = App.data.cats[t][0]; this.renderCats(); },
            renderCats() {
                const c = document.getElementById('cat-list'); c.innerHTML = '';
                const add = document.createElement('div'); add.className = 'cat-chip'; add.innerHTML = `<div class="cat-box" style="border:1px dashed var(--text-sec); background:transparent"><i data-lucide="plus"></i></div><span style="font-size:11px">Новая</span>`; add.onclick = () => Modals.catCreate(); c.appendChild(add);
                const edit = document.createElement('div'); edit.className = 'cat-chip'; edit.innerHTML = `<div class="cat-box" style="border:1px dashed var(--text-sec); background:transparent"><i data-lucide="${App.catEdit ? 'check' : 'edit-2'}"></i></div><span style="font-size:11px">${App.catEdit ? 'ОК' : 'Изм.'}</span>`; edit.onclick = () => { App.catEdit = !App.catEdit; this.renderCats(); }; c.appendChild(edit);
                App.data.cats[this.type].forEach(cat => {
                    const el = document.createElement('div'); el.className = `cat-chip ${App.catEdit ? 'editing' : ''}`; if(this.cat && this.cat.id === cat.id && !App.catEdit) el.classList.add('selected');
                    el.innerHTML = `<div class="cat-box"><i data-lucide="${cat.icon}"></i><div class="del-badge"><i data-lucide="x" width="12"></i></div></div><span style="font-size:11px">${cat.name}</span>`;
                    el.onclick = (e) => { if(App.catEdit && e.target.closest('.del-badge')) { App.data.cats[this.type] = App.data.cats[this.type].filter(x => x.id !== cat.id); Store.set(App.data); this.renderCats(); } else if (!App.catEdit) { this.cat = cat; document.querySelectorAll('.cat-chip').forEach(x => x.classList.remove('selected')); el.classList.add('selected'); } }; c.appendChild(el);
                });
                lucide.createIcons({root:c});
            },
            press(k) { if(this.buf==='0' && k!=='.') this.buf=''; if(k==='.'&&this.buf.includes('.'))return; this.buf+=k; this.upd(); },
            del() { this.buf = this.buf.slice(0,-1)||'0'; this.upd(); },
            clear() { this.buf = '0'; this.upd(); },
            toggle() { 
                if (this.buf !== '0') {
                    this.buf = this.buf.startsWith('-') ? this.buf.slice(1) : '-' + this.buf;
                    this.upd();
                }
            },
            percent() { 
                const s = this.buf; 
                const match = s.match(/(.*?)([\+\-\*\/])?([0-9.]+)$/); 
                if(!match) return;
                const [_, prefix, op, lastNum] = match; 
                const val = parseFloat(lastNum);
                if(!op || op === '*' || op === '/') { 
                    this.buf = prefix + (op || '') + (val / 100); 
                } else { 
                    const base = MathX.safeEval(prefix || '0'); 
                    this.buf = prefix + op + (base * val / 100); 
                }
                this.upd();
            },
            upd() { document.getElementById('calc-disp').innerText = this.buf; },
            save() { const val = MathX.safeEval(this.buf); if(val<=0 || !this.cat) return; const tx = { id: this.editId || Date.now().toString(), amount: App.toBase(val), type: this.type, catId: this.cat.id, catName: this.cat.name, icon: this.cat.icon, date: this.date, note: document.getElementById('note-input').value }; if(this.editId) { const i = App.data.txs.findIndex(x => x.id === this.editId); if(i!==-1) App.data.txs[i] = tx; } else App.data.txs.push(tx); Store.set(App.data); App.render(); this.editId = null; this.reset(); App.closeCalc(); }
        };

        const Modals = {
            el: document.getElementById('modal-gen'), body: document.getElementById('modal-body'), close() { this.el.classList.remove('open'); },
            openCur() { this.body.innerHTML = ''; CURRENCIES.forEach(c => { const r = document.createElement('div'); r.className = 'set-row'; r.innerHTML = `<span>${c}</span>${App.data.settings.currency===c?'<i data-lucide="check"></i>':''}`; r.onclick = () => { App.data.settings.currency=c; Store.set(App.data); App.render(); this.close(); }; this.body.appendChild(r); }); lucide.createIcons({root:this.body}); this.el.classList.add('open'); },
            catCreate() { this.body.innerHTML = `<input id="new-cat-name" class="t-input" placeholder="Название" style="width:100%; margin-bottom:15px"><div style="display:grid; grid-template-columns:repeat(6,1fr); gap:8px; max-height:200px; overflow-y:auto" id="icon-grid"></div><button class="t-input" style="width:100%; margin-top:15px; background:var(--text-main); color:var(--bg); font-weight:700" onclick="Modals.saveNewCat()">Создать</button>`; const g = document.getElementById('icon-grid'); ICONS.forEach(i => { const d = document.createElement('div'); d.style.cssText = 'height:40px; border:1px solid var(--border); border-radius:10px; display:flex; align-items:center; justify-content:center'; d.innerHTML = `<i data-lucide="${i}" width="18"></i>`; d.onclick = () => { document.querySelectorAll('#icon-grid div').forEach(x => x.style.background='transparent'); d.style.background = 'var(--text-sec)'; d.classList.add('picked'); d.dataset.val = i; }; g.appendChild(d); }); lucide.createIcons({root:g}); this.el.classList.add('open'); },
            saveNewCat() { const n = document.getElementById('new-cat-name').value, i = document.querySelector('.picked')?.dataset.val; if(n && i) { App.data.cats[Calc.type].push({id:Date.now().toString(), name:n, icon:i}); Store.set(App.data); Calc.renderCats(); this.close(); } }
        };

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
